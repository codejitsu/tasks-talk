<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Functional Continuous Deployment</title>

		<meta name="description" content="tasks: A framework for easily creating scripts in SBT">
		<meta name="author" content="codejitsu">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<!--<link rel="stylesheet" href="css/theme/black.css" id="theme">-->
		<link rel="stylesheet" href="css/theme/simple.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h2>Functional Continuous Deployment</h2>
					<h3>with <a href="http://github.com/codejitsu/tasks">tasks</a> & <a href="http://github.com/codejitsu/sbt-robot">sbt-robot</a></h3>
					<br/><br/>
					<p>Alexey Sverdelov <a href="https://github.com/codejitsu">github.com/codejitsu</a></p>
					<p><a href="mailto:me@codejitsu.net">me@codejitsu.net</a></p>
				</section>

				<section>
					<h2>Side projects</h2>
					<p>
					...to experiment with the power of Scala.
					</p>
				</section>

				<section>
					<section id="fragments">
						<h2>As a developer all I want is</h2>
						<p><span class="fragment">sbt &gt; clean test package</span> <span class="fragment fade-in" style="color:green">deploy</span></p>
					</section>
				</section>
				
				<section>
					<section id="deploy">
						<h2>Deploy</h2>
						<p><span class="fragment fade-in">build artifact</span></p>
						<p><span class="fragment fade-in">clean stage nodes</span></p>
						<p><span class="fragment fade-in">upload artifact</span></p>
						<p><span class="fragment fade-in">create Cassandra tables</span></p>
						<p><span class="fragment fade-in">restart Tomcats</span></p>
						<p><span class="fragment fade-in">check app</span></p>
					</section>
				</section>
				
				<section>
					<h2>I want</h2>
					<p>
					...reusable, composable tasks with fail-fast semantic 
					</p>
				</section>

				<section>
					<h2>tasks</h2>
					<p>Tasks is a library for building executable (shell)-scripts in a functional way.</p>
					<pre><code data-trim contenteditable>
  val deployApp =
      RmIfExists(hosts, artifact) andThen
      Upload(hosts, artifact) andThen
      StopTomcat(hosts) andThen
      Mv(artifact, webapps) andThen
      StartTomcat(hosts) andThen
      Wait(5 seconds) andThen
      CheckUrl(hosts, url) andThen
      NotifyMessageOk
					</code></pre>
				</section>
				
				<section>
					<h2>Predefined building blocks</h2>
					<ul>
						<li>Rm</li>
						<li>Mv</li>
						<li>Upload</li>
						<li>PostRequest</li>
						<li>StartTomcat</li>
						<li>...</li>
					</ul>
				</section>
				
				<section>
					<h2>Hosts DSL</h2>
					<pre><code data-trim contenteditable>
import net.codejitsu.tasks.dsl.Tasks._

val hosts = "test-host" | (1 to 25) | ".my.net.com"
// test-host1.my.net.com, test-host2.my.net.com, ..., test-host25.my.net.com

Rm(hosts, user.home / "myapp.war")
					</code></pre>
				</section>
				
				<section>
					<section id="tasks">
						<h2>Tasks are composable</h2>
						<p>
						<pre><code data-trim contenteditable>
val taskRm = Rm(hosts, user.home / artifact)

val taskUpload = Upload(hosts, artifact)

val taskComposition = taskRm andThen taskUpload
					</code></pre>	
						</p>
					</section>
				</section>
				<section>	
					<section id="par">
						<h2>Parallel all the things!</h2>
						<p>
						<pre><code data-trim contenteditable>

val taskRm = Par ~ Rm(hosts, user.home / artifact)

					</code></pre>	
						</p>
					</section>
				</section>

				<section>	
					<section id="sudo">
						<h2>Sudo all the things!</h2>
						<p>
						<pre><code data-trim contenteditable>

val taskRm = Sudo ~ Par ~ Rm(hosts, user.home / artifact)

					</code></pre>	
						</p>
					</section>
				</section>

				<section>
					<section id="orelse">
						<h2>But what if...</h2>
						<p>
						<pre><code data-trim contenteditable>

val tom = RestartTomcat(hosts) orElse MessageTomcatFailed

					</code></pre>	
						</p>
						
					</section>
				</section>

				<section>
					<h2>Example script</h2>
					<pre><code data-trim contenteditable>
  val deployApp =
      Par ~ RmIfExists(hosts, user.home / s"$artifact*") andThen
      Par ~ Upload(hosts, targetPath / artifact, user.home) andThen
      Sudo ~ Par ~ StopTomcat(hosts) andThen
      Sudo ~ Par ~ RmIfExists(hosts, webapps / s"$name*") andThen
      Sudo ~ Par ~ Mv(hosts, user.home / artifact, webapps) andThen
      Sudo ~ Par ~ StartTomcat(hosts) andThen
      Wait(5 seconds) andThen
      Par ~ CheckUrl(hosts, "/check/", 8080, _.contains("OK")) andThen
      NotifyDeploymentOk orElse 
      NotifyDeploymentFail
					</code></pre>
					<p><span class="fragment"><code>StopTomcat</code></span> <span class="fragment">in <i>production</i>?!</span></p>
					<p><span class="fragment fade-in" style="color:red"><b>:(</b></span></p>
				</section>
				
				<section>
					<section id="ac">
						<h2>Compile time access control!</h2>
						<p>
						<pre><code data-trim contenteditable>
implicit val stage = new Production

val stop = Sudo ~ Par ~ StopTomcat(hosts)

stop.run()
					</code></pre>	
						</p>
						<p>Compile time error:</p>
						<p>
						<pre><code data-trim contenteditable>
[error] /DeploySettings.scala:93: 
	Stage is not allowed to run task 'net.codejitsu.tasks.StopTomcat[S]'.
[error]     Sudo ~ Par ~ StopTomcat(hosts) andThen
				   ^
					</code></pre>								
						</p>
					</section>

				</section>

				<section>
					<section id="ac2">
						<h2>Compile time access control!</h2>
						<p>
						<pre><code data-trim contenteditable>
implicit val stage = new Production

implicit val allowStopTomInProd: Production Allow StopTomcat = 
	new Allow[Production, StopTomcat]

val stop = Sudo ~ Par ~ StopTomcat(hosts)

stop.run()
					</code></pre>	
						</p>
					<p><span class="fragment" style="color:green"><b>:)</b></span></p>
					</section>

				</section>

				<section>
					<section id="robot">
						<h2>SBT-Robot</h2>
						<p><span class="fragment fade-in">SBT plugin for <i>tasks</i></p>
						<p><span class="fragment fade-in">create task:</p>
						<p><span class="fragment fade-in"><code>val deployApp = ...</code></p>
						<p><span class="fragment fade-in">install task in SBT:</p>
						<p><span class="fragment fade-in"><code>defineTask(deployApp, "deploy")</code></p>
						<p><span class="fragment fade-in">Enjoy :)</p>
						<p><span class="fragment">sbt &gt; clean test package</span> <span class="fragment fade-in" style="color:green">robot:deploy</span></p>
					</section>

				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
